---
title: "Supplyshed Scenario Exploration"
author: "J. Stephenson"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)#,
                      #fig.width = 12,
                      #fig.height = 12)

library("tidyverse"); theme_set(theme_bw())
library("lme4")
library("lmerTest")
library("emmeans")
library("ggResidpanel")

options(scipen = 999, width = 200)

dir.create("fig", showWarnings = FALSE)
```


```{r create_df, cache.extra=tools::md5sum("../code/CBS_practiceSummary.csv")}
## Generate dataframe
## crop acres = all cropped acres within the drainage area of the practice.
CBS_BIOraw <- read_csv("../code/CBS_practiceSummary_BIO.csv") %>%
  mutate(practice = "CBS",
         pID = FBndID,
         IWAP = 2,
         INRS = "Perennial crops",
         biomass = "prairie",
         adjOCost = OpportunityCost,
         opArea_ha = opAcres*0.404686, ## convert ac to ha
         cropArea_ha = SUM_cropAcres*0.404686, ## convert ac to ha
         cpNO3ldkg = SUM_cpNO3load*0.453592, ## convert lb to kg
         cpNO3ldRedkg = SUM_cpNO3LoadReduced*0.453592, ## convert lb to kg
         cpSEDldkg = SUM_cpSEDloadlbs*0.453592, ## convert lb to kg
         cpSEDldRedkg = SUM_cpSEDLoadReduced*907.18, ## convert US tons to kg
         DC_kgNO3 = DirectCost / cpNO3ldRedkg,
         TC_kgNO3 = TotalCost / cpNO3ldRedkg,
         DC_kgSED = DirectCost / cpSEDldRedkg,
         TC_kgSED = TotalCost / cpSEDldRedkg) %>%
  select(MLRA,HUC12,pID,practice,opArea_ha,cropArea_ha,IWAP,INRS,DirectCost,OpportunityCost,
         adjOCost,TotalCost,FBndID,biomass,bioYield,energyPot,CO2red,N2Ored,
         cpNO3ldkg,cpNO3ldRedkg,cpSEDldkg,cpSEDldRedkg,
         DC_kgNO3,TC_kgNO3,DC_kgSED,TC_kgSED)

## crop acres = all cropped acres within the drainage area of the practice.
NRW_BIOraw <- read_csv("../code/NRW_practiceSummary_BIO.csv") %>%
  mutate(practice = "NRW",
         pID = SiteID,
         IWAP = 0,
         INRS = "Treatment wetlands",
         biomass = "prairie",
         adjOCost = OpportunityCost,
         opArea_ha = opAcres*0.404686, # convert ac to ha
         cropArea_ha = SUM_cropAcres*0.404686, # convert ac to ha
         cpNO3ldkg = SUM_cpNO3load*0.453592, ## convert lb to kg
         cpNO3ldRedkg = SUM_cpNO3LoadReduced*0.453592, ## convert lb to kg
         cpSEDldkg = SUM_cpSEDloadlbs*0.453592, ## convert lb to kg
         cpSEDldRedkg = SUM_cpSEDLoadReduced*907.18, ## convert US tons to kg
         DC_kgNO3 = DirectCost / cpNO3ldRedkg,
         TC_kgNO3 = TotalCost / cpNO3ldRedkg,
         DC_kgSED = DirectCost / cpSEDldRedkg,
         TC_kgSED = TotalCost / cpSEDldRedkg) %>%
  select(MLRA,HUC12,pID,practice,opArea_ha,cropArea_ha,IWAP,INRS,DirectCost,OpportunityCost,
         adjOCost,TotalCost,FBndID,biomass,bioYield,energyPot,CO2red,N2Ored,
         cpNO3ldkg,cpNO3ldRedkg,cpSEDldkg,cpSEDldRedkg,
         DC_kgNO3,TC_kgNO3,DC_kgSED,TC_kgSED)

## crop acres = field acres
PCP_BIOraw <- read_csv("../code/PCP_practiceSummary_BIO.csv") %>%
  mutate(practice = "PCP",
         pID = FBndID,
         IWAP = 1,
         INRS = "Perennial crops",
         biomass = "prairie",
         adjOCost = OpportunityCost,
         opArea_ha = opAcres*0.404686, # convert ac to ha
         cropArea_ha = cropAcres*0.404686, # convert ac to ha
         cpNO3ldkg = cpNO3load*0.453592, ## convert lb to kg
         cpNO3ldRedkg = cpNO3LoadReduced*0.453592, ## convert lb to kg
         cpSEDldkg = cpSEDloadlbs*0.453592, ## convert lb to kg
         cpSEDldRedkg = cpSEDLoadReduced*907.18, ## convert US tons to kg
         DC_kgNO3 = DirectCost / cpNO3ldRedkg,
         TC_kgNO3 = TotalCost / cpNO3ldRedkg,
         DC_kgSED = DirectCost / cpSEDldRedkg,
         TC_kgSED = TotalCost / cpSEDldRedkg) %>%
  select(MLRA,HUC12,pID,practice,opArea_ha,cropArea_ha,IWAP,INRS,DirectCost,OpportunityCost,
         adjOCost,TotalCost,FBndID,biomass,bioYield,energyPot,CO2red,N2Ored,
         cpNO3ldkg,cpNO3ldRedkg,cpSEDldkg,cpSEDldRedkg,
         DC_kgNO3,TC_kgNO3,DC_kgSED,TC_kgSED)

## crop acres = all cropped acres within the drainage area of the practice.
STB_BIOraw <- read_csv("../code/STB_practiceSummary_BIO.csv") %>%
  mutate(practice = "STB",
         pID = riparianid,
         IWAP = 2,
         INRS = "Riparian buffers",
         biomass = "prairie",
         adjOCost = adjOCosts,
         TotalCost = adjOCost + DirectCost,
         opArea_ha = opAcres*0.404686, # convert ac to ha
         cropArea_ha = SUM_cropAcres*0.404686, # convert ac to ha
         cpNO3ldkg = SUM_cpNO3load*0.453592, ## convert lb to kg
         cpNO3ldRedkg = SUM_cpNO3LoadReduced*0.453592, ## convert lb to kg
         cpSEDldkg = SUM_cpSEDloadlbs*0.453592, ## convert lb to kg
         cpSEDldRedkg = SUM_cpSEDLoadReduced*907.18, ## convert US tons to kg
         DC_kgNO3 = DirectCost / cpNO3ldRedkg,
         TC_kgNO3 = TotalCost / cpNO3ldRedkg,
         DC_kgSED = DirectCost / cpSEDldRedkg,
         TC_kgSED = TotalCost / cpSEDldRedkg) %>%
  select(MLRA,HUC12,pID,practice,opArea_ha,cropArea_ha,IWAP,INRS,DirectCost,OpportunityCost,
         adjOCost,TotalCost,FBndID,biomass,bioYield,energyPot,CO2red,N2Ored,
         cpNO3ldkg,cpNO3ldRedkg,cpSEDldkg,cpSEDldRedkg,
         DC_kgNO3,TC_kgNO3,DC_kgSED,TC_kgSED)

## crop acres = field acres
WCR_BIOraw <- read_csv("../code/WCR_practiceSummary_BIO.csv") %>%
  mutate(practice = "WCR",
         pID = FBndID,
         IWAP = 0,
         INRS = "Rye cover crops",
         biomass = "rye",
         adjOCost = OpportunityCost,
         opArea_ha = opAcres*0.404686, # convert ac to ha
         cropArea_ha = cropAcres*0.404686, # convert ac to ha
         TotalCost = DirectCost,
         cpNO3ldkg = cpNO3load*0.453592, ## convert lb to kg
         cpNO3ldRedkg = cpNO3LoadReduced*0.453592, ## convert lb to kg
         cpSEDldkg = cpSEDloadlbs*0.453592, ## convert lb to kg
         cpSEDldRedkg = cpSEDLoadReduced*907.18, ## convert US tons to kg
         DC_kgNO3 = DirectCost / cpNO3ldRedkg,
         TC_kgNO3 = TotalCost / cpNO3ldRedkg,
         DC_kgSED = DirectCost / cpSEDldRedkg,
         TC_kgSED = TotalCost / cpSEDldRedkg) %>%
  select(MLRA,HUC12,pID,practice,opArea_ha,cropArea_ha,IWAP,INRS,DirectCost,OpportunityCost,
         adjOCost,TotalCost,FBndID,biomass,bioYield,energyPot,CO2red,N2Ored,
         cpNO3ldkg,cpNO3ldRedkg,cpSEDldkg,cpSEDldRedkg,
         DC_kgNO3,TC_kgNO3,DC_kgSED,TC_kgSED)

practSumBIO_df <- rbind(CBS_BIOraw, NRW_BIOraw, PCP_BIOraw, STB_BIOraw, WCR_BIOraw)
practSumBIO <- within(practSumBIO_df, MLRA[MLRA == 108] <- "108c")
practSumBIO <- within(practSumBIO, MLRA[MLRA == 115] <- "115c")

## Currently the acres in these tables represent the entire HUC12 area and not just the crop acres.
wsTotalNO3Load <- read_csv("../code/wsTotalNO3Load.csv") %>%
  mutate(pollutant = "nitrate",
         loadkg = SUM_wsNO3load*0.453592) %>% # convert lb to kg
  select(HUC12,pollutant,loadkg)
         
wsTotalSEDLoad <- read_csv("../code/wsTotalSEDLoad.csv") %>%
  mutate(pollutant = "sediment",
         loadkg = SUM_Mean_sed_lbs*0.453592) %>% # convert lb to kg
  select(HUC12,pollutant,loadkg)

wsLoad <- rbind(wsTotalNO3Load, wsTotalSEDLoad)


## field loads to estimate load by MLRA.
fbMgmt<- read_csv("../code/fbNO3Load.csv") %>%
  mutate(NO3load_kgha = NO3loadAc*0.892179, # convert lb per ac to kg per ha
         Nrate_kgha = Nrate*0.892179, # convert lb per ac to kg per ha
         hectares = Acres * 0.404686) %>% # convert ac per ha
  select(MLRA,FBndID,isAG,hectares,inSup,GenLU,CropRotatn,Nrate_kgha,NO3load_kgha)

fbSieversRoute <-  read_csv("../code/fbSieversRoutes.csv") %>%
  mutate(FBndID = trimws(sub("^([^-]+)-.*$", "\\1", Name),which="right")) %>%
  select(FBndID,Total_TruckTravelTime,Total_Kilometers)
  
fbNO3Load <- read_csv("../code/fbNO3Load.csv") %>%
  mutate(pollutant = "nitrate",
         hectares = Acres*0.404686, # convert ac per ha
         loadkg = (Acres*NO3loadAc)*0.453592) %>% # convert lb to kg
  select(MLRA,FBndID,isAG,hectares,inSup,pollutant,loadkg)
         
fbSEDLoad <- read_csv("../code/fbSEDLoad.csv") %>%
  mutate(pollutant = "sediment",
         hectares = Acres*0.404686, # convert ac per ha
         loadkg = Mean_sed_lbs*0.453592) %>% # convert lb to kg
  select(MLRA,FBndID,isAG,hectares,inSup,pollutant,loadkg)

fbLoad <- rbind(fbNO3Load, fbSEDLoad) %>%
  drop_na()


## Dataframe check
#head(practSum)
#head(wsLoad)
summary(practSumBIO)
unique(practSumBIO$MLRA)
#summary(wsLoad)

```

```{r explore_df, dependson="create_df"}
practMLRA_counts <- practSumBIO %>%
         group_by(MLRA, practice) %>%
         summarize(hectares = sum(opArea_ha), 
                   n = n(), .groups = "drop")

bioMLRA_counts <- practSumBIO %>%
         group_by(MLRA, biomass) %>%
         summarize(hectares = sum(opArea_ha), 
                   n = n(), .groups = "drop")

practHUC12_counts <- practSumBIO %>%
         group_by(HUC12, practice) %>%
         summarize(hectares = sum(opArea_ha),
                   n = n(), .groups = "drop")

bioHUC12_counts <- practSumBIO %>%
         group_by(HUC12, biomass) %>%
         summarize(hectares = sum(opArea_ha),
                   n = n(), .groups = "drop")

IWAPHUC12_counts <- practSumBIO %>%
  filter(IWAP >0) %>%
  group_by(HUC12,IWAP) %>%
  summarize(hectares = sum(opArea_ha),
          n = n(), .groups = "drop")
         
```

```{r mean_data, dependson = "create_soilpad"}
## How much is it going to cost to realize the INRS? How much to achieve wildlife goals?
practMLRA_CostSumBIOno3 <- practSumBIO %>% drop_na(cpNO3ldkg) %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(MLRA, INRS) %>%
  summarize(sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            meanDC  = round(mean(DirectCost, na.rm = TRUE),0),
            minDC = round(min(DirectCost),0),
            maxDC = round(max(DirectCost),0),
            meanOC  = round(mean(adjOCost, na.rm = TRUE),0),
            minOC = round(min(adjOCost),0),
            maxOC = round(max(adjOCost),0),
            meanTC  = round(mean(TotalCost, na.rm = TRUE),0),
            minTC = round(min(TotalCost),0),
            maxTC = round(max(TotalCost),0),
            meanDC_kgNO3  = mean(DC_kgNO3, na.rm = TRUE),
            minDC_kgNO3 = min(DC_kgNO3, na.rm = TRUE),
            maxDC_kgNO3 = max(DC_kgNO3, na.rm = TRUE),
            meanTC_kgNO3 = mean(TC_kgNO3, na.rm = TRUE),
            minTC_kgNO3 = min(TC_kgNO3, na.rm = TRUE),
            maxTC_kgNO3 = max(TC_kgNO3, na.rm = TRUE),
            opAcres = sum(opArea_ha),
            n       = n(),
            .groups = "drop")

write_csv(practMLRA_CostSumBIOno3,"practMLRA_CostSumBIOno3.csv")

practMLRA_CostSumBIOsed <- practSumBIO %>% drop_na(cpSEDldkg) %>% filter(DC_kgSED > 0) %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(MLRA, INRS) %>%
  summarize(sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            meanDC  = round(mean(DirectCost, na.rm = TRUE),0),
            minDC = round(min(DirectCost),0),
            maxDC = round(max(DirectCost),0),
            meanOC  = round(mean(adjOCost, na.rm = TRUE),0),
            minOC = round(min(adjOCost),0),
            maxOC = round(max(adjOCost),0),
            meanTC  = round(mean(TotalCost, na.rm = TRUE),0),
            minTC = round(min(TotalCost),0),
            maxTC = round(max(TotalCost),0),
            meanDC_kgSed  = mean(DC_kgSED, na.rm = TRUE),
            minDC_kgSED = min(DC_kgSED, na.rm = TRUE),
            maxDC_kgSED = max(DC_kgSED, na.rm = TRUE),
            meanDC_kgSED  = mean(TC_kgSED, na.rm = TRUE),
            minDC_kgSED = min(TC_kgSED, na.rm = TRUE),
            maxDC_kgSED = max(TC_kgSED, na.rm = TRUE),
            opAcres = sum(opArea_ha),
            n       = n(),
            .groups = "drop")

write_csv(practMLRA_CostSumBIOsed,"practMLRA_CostSumBIOsed.csv")


## Which HUC12 should we start with?
practHUC12_CostSumBIOno3 <- practSumBIO %>% drop_na(cpNO3ldkg) %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(HUC12) %>%
  summarize(sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            sumCO2red = sum(CO2red),
            sumN2ored = sum(N2Ored),
            sumcpNO3ldRedkg = sum(cpNO3ldRedkg, na.rm = TRUE),
            meanDC  = round(mean(DirectCost, na.rm = TRUE),0),
            minDC = round(min(DirectCost),0),
            maxDC = round(max(DirectCost),0),
            meanOC  = round(mean(adjOCost, na.rm = TRUE),0),
            minOC = round(min(adjOCost),0),
            maxOC = round(max(adjOCost),0),
            meanTC  = round(mean(TotalCost, na.rm = TRUE),0),
            minTC = round(min(TotalCost),0),
            maxTC = round(max(TotalCost),0),
            meanDCredNO3  = mean(DC_kgNO3, na.rm = TRUE),
            minDCredNO3 = min(DC_kgNO3, na.rm = TRUE),
            maxDCredNO3 = max(DC_kgNO3, na.rm = TRUE),
            meanTCredNO3 = mean(TC_kgNO3, na.rm = TRUE),
            minTCredNO3 = min(TC_kgNO3, na.rm = TRUE),
            maxTCredNO3 = max(TC_kgNO3, na.rm = TRUE),
            opAcres = sum(opArea_ha),
            n       = n(),
            .groups = "drop")

write_csv(practHUC12_CostSumBIOno3,"practHUC12_CostSumBIOno3.csv")

practHUC12_CostSumBIOsed <- practSumBIO %>% drop_na(cpSEDldkg) %>% filter(DC_kgSED > 0) %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(HUC12) %>%
  summarize(sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            sumcpSEDldRedkg = sum(cpSEDldRedkg, na.rm = TRUE),
            meanDC  = round(mean(DirectCost, na.rm = TRUE),0),
            minDC = round(min(DirectCost),0),
            maxDC = round(max(DirectCost),0),
            meanOC  = round(mean(adjOCost, na.rm = TRUE),0),
            minOC = round(min(adjOCost),0),
            maxOC = round(max(adjOCost),0),
            meanTC  = round(mean(TotalCost, na.rm = TRUE),0),
            minTC = round(min(TotalCost),0),
            maxTC = round(max(TotalCost),0),
            meanDCredSED  = mean(DC_kgSED, na.rm = TRUE),
            minDCredSED = min(DC_kgSED, na.rm = TRUE),
            maxDCredSED = max(DC_kgSED, na.rm = TRUE),
            meanTCredSED  = mean(TC_kgSED, na.rm = TRUE),
            minTCredSED = min(TC_kgSED, na.rm = TRUE),
            maxTCredSED = max(TC_kgSED, na.rm = TRUE),
            opAcres = sum(opArea_ha),
            n       = n(),
            .groups = "drop")

write_csv(practHUC12_CostSumBIOsed,"practHUC12_CostSumBIOsed.csv")

# How much will it cost to achieve IWAP?
practIWAP_CostSumBIO <- practSumBIO %>% filter(IWAP == 1) %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(MLRA) %>%
  summarize(sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            meanDC  = round(mean(DirectCost, na.rm = TRUE),0),
            minDC = round(min(DirectCost),0),
            maxDC = round(max(DirectCost),0),
            meanOC  = round(mean(adjOCost, na.rm = TRUE),0),
            minOC = round(min(adjOCost),0),
            maxOC = round(max(adjOCost),0),
            meanTC  = round(mean(TotalCost, na.rm = TRUE),0),
            minTC = round(min(TotalCost),0),
            maxTC = round(max(TotalCost),0),
            opAcres = sum(opArea_ha),
            n       = n(),
            .groups = "drop")

write_csv(practIWAP_CostSumBIO,"practIWAP_CostSumBIO.csv")

```

```{r explore_df, dependson="create_df"}
ggplot(data, aes(x=name, y=value)) + 
  geom_bar(stat = "identity")

DC_kgNO3confintBIO <- practSumBIO %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(MLRA,INRS) %>%
  reframe(mean = mean(DC_kgNO3, na.rm=TRUE),
            median = median(DC_kgNO3, na.rm = TRUE),
            n = length(DC_kgNO3),
            sd = sd(DC_kgNO3, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(TC_kgSED),
            max = max(TC_kgSED))

TC_kgNO3confintBIO <- practSumBIO %>%
  filter(cpSEDldRedkg >= 0) %>%
  group_by(MLRA,INRS) %>%
  reframe(mean = mean(TC_kgNO3, na.rm=TRUE),
            median = median(TC_kgNO3, na.rm = TRUE),
            n = length(TC_kgNO3),
            sd = sd(TC_kgNO3, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(TC_kgSED),
            max = max(TC_kgSED))

DC_kgSEDconfintBIO <- practSumBIO %>% 
  filter(cpSEDldRedkg >= 0) %>%
  group_by(MLRA,INRS) %>%
  summarize(mean = mean(DC_kgSED, na.rm=TRUE),
            median = median(DC_kgSED, na.rm = TRUE),
            n = length(DC_kgSED),
            sd = sd(DC_kgSED, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(TC_kgSED),
            max = max(TC_kgSED))

TC_kgSEDconfintBIO <- practSumBIO %>%
  group_by(MLRA,INRS) %>%
  filter(cpSEDldRedkg >= 0) %>%
  summarize(mean = mean(TC_kgSED, na.rm=TRUE),
            median = median(TC_kgSED, na.rm = TRUE),
            n = length(TC_kgSED),
            sd = sd(TC_kgSED, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(TC_kgSED),
            max = max(TC_kgSED))

DC_kgNO3confintBIOSup <- practSumBIO %>%
  group_by(INRS) %>%
  filter(cpSEDldRedkg >= 0) %>%
  summarize(mean = mean(DC_kgNO3, na.rm=TRUE),
            median = median(DC_kgNO3, na.rm = TRUE),
            n = length(DC_kgNO3),
            sd = sd(DC_kgNO3, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(DC_kgNO3),
            max = max(DC_kgNO3))

TC_kgNO3confintBIOSup <- practSumBIO %>%
  group_by(INRS) %>%
  filter(cpSEDldRedkg >= 0) %>%
  summarize(mean = mean(TC_kgNO3, na.rm=TRUE),
            median = median(TC_kgNO3, na.rm = TRUE),
            n = length(TC_kgNO3),
            sd = sd(TC_kgNO3, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(TC_kgNO3),
            max = max(TC_kgNO3))

DC_kgSEDconfintBIOSup <- practSumBIO %>%
  group_by(INRS) %>%
  filter(cpSEDldRedkg >= 0) %>%
  summarize(mean = mean(DC_kgSED, na.rm=TRUE),
            median = median(DC_kgSED, na.rm = TRUE),
            n = length(DC_kgSED),
            sd = sd(DC_kgSED, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(DC_kgSED),
            max = max(DC_kgSED))

TC_kgSEDconfintBIOSup <- practSumBIO %>%
  group_by(INRS) %>%
  filter(cpSEDldRedkg >= 0) %>%
  summarize(mean = mean(TC_kgSED, na.rm=TRUE),
            median = median(TC_kgSED, na.rm = TRUE),
            n = length(TC_kgSED),
            sd = sd(TC_kgSED, na.rm = TRUE),
            se = sd / sqrt(n),
            t.score = qt(p= 0.05/2, df = (n-1), lower.tail = F),
            margErr = t.score*se,
            lb = mean - margErr,
            ub = mean + margErr,
            min = min(TC_kgSED),
            max = max(TC_kgSED))

write_csv(DC_kgNO3confintBIO,"DC_kgNO3confintBIO.csv")
write_csv(TC_kgNO3confintBIO,"TC_kgNO3confintBIO.csv")
write_csv(DC_kgSEDconfintBIO,"DC_kgSEDconfintBIO.csv")
write_csv(TC_kgSEDconfintBIO,"TC_kgSEDconfintBIO.csv")

```



Compare costs. It might be interesting to visually have a side-by-side comparison of direct, 
total, and opportunity costs. 
```{r explore_df, dependson="create_df"}
practSum_TC_kgSED <- filter(practSumBIO, TC_kgSED < 1000)

fbLoadSumStat <- fbLoad %>% 
  filter(loadkg > 0) %>%
  group_by(MLRA, pollutant) %>%
  summarise(n=n(),
            sumLoadmt = sum(loadlbs)/2205, ## lb to metric tons
            meankg = mean(loadlbs/2.2), ## lb to kg
            sdkg=sd(loadlbs/2.2),
            sekg=(sdkg/sqrt(n)))

ggplot(fbLoadSumStat, aes(MLRA, meankg, fill=pollutant)) +
  geom_bar(stat = "identity",position=position_dodge()) +
  geom_errorbar(aes(x=MLRA, ymin=meankg-sekg, ymax=meankg+sekg), width=0.4, 
                position = position_dodge(0.9)) +
  scale_fill_manual(values=c("#999999", "#999123")) +
  ggtitle("Mean Pollutant Load Per Field by MLRA (SE plotted)") +
  xlab("MLRA") +
  ylab("Pollutant Load (kg)")

ggplot(fbLoadSumStat, aes(MLRA, (sumLoadmt), fill=pollutant)) +
  geom_bar(stat = "identity",position=position_dodge()) +
  scale_fill_manual(values=c("#999999", "#999123")) +
  ggtitle("Total Pollutant Load Per Field by MLRA") +
  xlab("MLRA") +
  ylab("Pollutant Load (tonnes)")
##make a graph comparing direct, opportunity, and total costs per practice

```

Look at bioyield and transportation costs
```{r mean_data, dependson = "create_soilpad"}
## How much is it going to cost to realize the INRS? How much to achieve wildlife goals?
bio_CostSumNO3 <- practSumBIO %>% drop_na(cpNO3ldkg) %>%
  group_by(FBndID, biomass) %>%
  summarize(opArea_ha = sum(opArea_ha),
            n       = n(),
            sumbioYield = sum(bioYield),
            sumEnergyPot = sum(energyPot),
            sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            meanDC_kgNO3  = mean(DC_kgNO3, na.rm = TRUE),
            minDC_kgNO3 = min(DC_kgNO3, na.rm = TRUE),
            maxDC_kgNO3 = max(DC_kgNO3, na.rm = TRUE),
            meanTC_kgNO3 = mean(TC_kgNO3, na.rm = TRUE),
            minTC_kgNO3 = min(TC_kgNO3, na.rm = TRUE),
            maxTC_kgNO3 = max(TC_kgNO3, na.rm = TRUE),
            .groups = "drop")

bio_CostSumSED <- practSumBIO %>% drop_na(cpSEDldkg) %>%
  group_by(FBndID, biomass) %>%
  summarize(opArea_ha = sum(opArea_ha),
            n       = n(),
            sumbioYield = sum(bioYield),
            sumEnergyPot = sum(energyPot),
            sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            meanDC_kgSED  = mean(DC_kgSED, na.rm = TRUE),
            minDC_kgSED = min(DC_kgSED, na.rm = TRUE),
            maxDC_kgSED = max(DC_kgSED, na.rm = TRUE),
            meanTC_kgSED  = mean(TC_kgSED, na.rm = TRUE),
            minTC_kgSED = min(TC_kgSED, na.rm = TRUE),
            maxTC_kgSED = max(TC_kgSED, na.rm = TRUE),
            .groups = "drop")

envOutcome_CostSum <- practSumBIO %>%
  group_by(FBndID) %>%
  summarize(opArea_ha = sum(opArea_ha),
            n       = n(),
            MLRA = max(MLRA),
            HUC12 = max(HUC12),
            sumbioYield = sum(bioYield),
            sumEnergyPot = sum(energyPot),
            sumDC = sum(DirectCost),
            sumOC = sum(adjOCost),
            sumTC = sum(TotalCost),
            sumCO2red = sum(CO2red),
            sumN2ored = sum(N2Ored),
            sumcpNO3LoadReduced = sum(cpNO3ldRedkg, na.rm = TRUE),
            minNO3Red = min(cpNO3ldRedkg),
            maxNO3Red = max(cpNO3ldRedkg),
            sumcpSEDLoadReduced = sum(cpSEDldRedkg, na.rm = TRUE),
            minSEDRed = min(cpSEDldRedkg),
            maxSEDRed = max(cpSEDldRedkg),
            IWAP = max(IWAP),
            sumDC_kgNO3 = sum(DC_kgNO3, na.rm = TRUE),
            minDC_kgNO3 = min(DC_kgNO3),
            maxDC_kgNO3 = max(DC_kgNO3),
            sumTC_kgNO3 = sum(TC_kgNO3, na.rm = TRUE),
            minTC_kgNO3 = min(TC_kgNO3),
            maxTC_kgNO3 = max(TC_kgNO3),
            sumDC_kgSED = sum(DC_kgSED, na.rm = TRUE),
            minDC_kgSED = min(DC_kgSED),
            maxDC_kgSED = max(DC_kgSED),
            sumTC_kgSED = sum(TC_kgSED, na.rm = TRUE),
            minTC_kgSED = min(TC_kgSED),
            maxTC_kgSED = max(TC_kgSED))#,
            #.groups = "drop")

travel_envOutcomes <- full_join(envOutcome_CostSum, fbSieversRoute)

travel_Sum <- travel_envOutcomes %>%
  group_by(HUC12) %>%
  summarize(sum_hectares = sum(opArea_ha),
            sum_bioYield = sum(sumbioYield),
            sum_enPot = sum(sumEnergyPot),
            mean_time = mean(Total_TruckTravelTime),
            mean_dist = mean(Total_Kilometers))

write_csv(travel_Sum,"bioHUC12.csv")

## QA/QC for transportation routes to ensure number of routes and locations match
## use spatial join to add FBndID to STB and NRW
# travelNA <- routes %>% filter(is.na(Total_TruckTravelTime))
# removeRoute <- bio_travelNO3 %>% filter(is.na(IWAP))
# routes <- bio_travelNO3 %>% drop_na(IWAP)
# write_csv(routes,"finalRoutes.csv")
# write_csv(travelNA, "missingRoutes.csv")

GHGsum <- practSumBIO %>%
  group_by(MLRA) %>%
  summarize(opArea_ha = sum(opArea_ha),
            n       = n(),
            MLRA = max(MLRA),
            sumCO2red = sum(CO2red),
            sumN2ored = sum(N2Ored),
            sumcpNO3LoadReduced = sum(cpNO3ldRedkg, na.rm = TRUE),
            minNO3Red = min(cpNO3ldRedkg, na.rm=TRUE),
            maxNO3Red = max(cpNO3ldRedkg, na.rm=TRUE),
            sumcpSEDLoadReduced = sum(cpSEDldRedkg, na.rm = TRUE),
            minSEDRed = min(cpSEDldRedkg, na.rm = TRUE),
            maxSEDRed = max(cpSEDldRedkg, na.rm=TRUE),
            IWAP = max(IWAP),
            .groups = "drop")

practIWAP_Sum <- practSumBIO %>%
  filter(IWAP == 1) %>%
  group_by(HUC12) %>%
  summarize(n       = n(),
            hectares = sum(opArea_ha),
            mean_ha = mean(opArea_ha),
            sd = sd(opArea_ha),
            se=(sd/sqrt(n)),
            min_ha = min(opArea_ha),
            max_ha = max(opArea_ha),
            .groups = "drop")

```